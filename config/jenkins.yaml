# Jenkins Configuration as Code (JCasC)
# Fixed Job DSL syntax based on official remote-file-plugin docs

jenkins:
  systemMessage: |
    CI/CD Pipeline Server
    Projects: KinDash, ReasonBridge

  numExecutors: 0
  mode: EXCLUSIVE
  quietPeriod: 5
  scmCheckoutRetryCount: 3

  securityRealm:
    local:
      allowsSignup: false
      users: []

  authorizationStrategy:
    globalMatrix:
      entries:
        - user:
            name: "admin"
            permissions:
              - "Overall/Administer"
        - user:
            name: "tony"
            permissions:
              - "Overall/Administer"
        - group:
            name: "authenticated"
            permissions:
              - "Overall/Read"

  nodes:
    - permanent:
        name: "runner-1"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 2
        mode: NORMAL
        labelString: "linux docker unit integration"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

    - permanent:
        name: "runner-2"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 2
        mode: NORMAL
        labelString: "linux docker unit integration"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

    - permanent:
        name: "runner-3"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 1
        mode: NORMAL
        labelString: "linux docker e2e playwright"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

    - permanent:
        name: "runner-4"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 1
        mode: NORMAL
        labelString: "linux docker e2e playwright"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

    - permanent:
        name: "runner-5"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 2
        mode: NORMAL
        labelString: "linux docker unit integration"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

    - permanent:
        name: "runner-6"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 2
        mode: NORMAL
        labelString: "linux docker unit integration"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

    - permanent:
        name: "runner-7"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 1
        mode: NORMAL
        labelString: "linux docker e2e playwright"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

    - permanent:
        name: "runner-8"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 1
        mode: NORMAL
        labelString: "linux docker e2e playwright"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

  globalNodeProperties:
    - envVars:
        env:
          - key: "CI"
            value: "true"
          - key: "NODE_ENV"
            value: "test"
          - key: "JWT_SECRET"
            value: "test-jwt-secret"
          - key: "ENCRYPTION_KEY"
            value: "test-encryption-key-32-chars-long!"

security:
  globalJobDslSecurityConfiguration:
    useScriptSecurity: false

unclassified:
  globalLibraries:
    libraries:
      - name: "kindash-lib"
        defaultVersion: "main"
        implicit: false
        allowVersionOverride: true
        retriever:
          modernSCM:
            scm:
              git:
                remote: "https://github.com/steiner385/kindash-jenkins-lib.git"
                credentialsId: "github-credentials"
      - name: "reasonbridge-lib"
        defaultVersion: "main"
        implicit: false
        allowVersionOverride: true
        retriever:
          modernSCM:
            scm:
              git:
                remote: "https://github.com/steiner385/reasonbridge-jenkins-lib.git"
                credentialsId: "github-credentials"

  location:
    adminAddress: "admin@kindash.com"
    url: "https://jenkins.kindash.com/"

  gitHubConfiguration:
    apiRateLimitChecker: ThrottleOnOver

  gitHubPluginConfig:
    configs:
      - credentialsId: "github-token"
        name: "GitHub"
        apiUrl: "https://api.github.com"
        manageHooks: true

  buildDiscarders:
    configuredBuildDiscarders:
      - "jobBuildDiscarder"

  timestamper:
    allPipelines: true

tool:
  git:
    installations:
      - name: "Default"
        home: "git"

credentials:
  system:
    domainCredentials:
      - credentials:
          - usernamePassword:
              scope: GLOBAL
              id: "github-credentials"
              username: "${GITHUB_USERNAME}"
              password: "${GITHUB_TOKEN}"
              description: "GitHub credentials"

          - string:
              scope: GLOBAL
              id: "github-token"
              secret: "${GITHUB_TOKEN}"
              description: "GitHub Personal Access Token"

          - string:
              scope: GLOBAL
              id: "database-url"
              secret: "postgresql://ci_user:ci_password@localhost:5433/ci_test_db"
              description: "Database URL for CI tests"

          - string:
              scope: GLOBAL
              id: "aws-access-key-id"
              secret: "${AWS_ACCESS_KEY_ID}"
              description: "AWS Access Key ID for Bedrock"

          - string:
              scope: GLOBAL
              id: "aws-secret-access-key"
              secret: "${AWS_SECRET_ACCESS_KEY}"
              description: "AWS Secret Access Key for Bedrock"

          - string:
              scope: GLOBAL
              id: "aws-region"
              secret: "${AWS_REGION:-us-east-1}"
              description: "AWS Region for Bedrock"

# Job Definitions - using syntax from remote-file-plugin official docs
jobs:
  # KinDash Multi-branch Pipeline
  - script: |
      multibranchPipelineJob('KinDash-multibranch') {
        displayName('KinDash Branches')
        description('Multi-branch pipeline for all KinDash branches and PRs')
        branchSources {
          github {
            id('kindash-github-source')
            repoOwner('steiner385')
            repository('KinDash')
            scanCredentialsId('github-credentials')
            buildOriginBranch(true)
            buildOriginBranchWithPR(false)
            buildOriginPRMerge(true)
            buildOriginPRHead(false)
            buildForkPRMerge(false)
          }
        }
        factory {
          remoteJenkinsFileWorkflowBranchProjectFactory {
            localMarker('')
            matchBranches(false)
            remoteJenkinsFile('Jenkinsfile.multibranch')
            remoteJenkinsFileSCM {
              gitSCM {
                userRemoteConfigs {
                  userRemoteConfig {
                    name('origin')
                    url('https://github.com/steiner385/kindash-jenkins-lib.git')
                    refspec('main')
                    credentialsId('github-credentials')
                  }
                }
                branches {
                  branchSpec {
                    name('main')
                  }
                }
                browser {}
                gitTool('')
              }
            }
          }
        }
        orphanedItemStrategy {
          discardOldItems {
            numToKeep(30)
            daysToKeep(60)
          }
        }
        triggers {
          periodicFolderTrigger {
            interval('5 minutes')
          }
        }
      }

  # ReasonBridge Multi-branch Pipeline
  - script: |
      multibranchPipelineJob('ReasonBridge-ci') {
        displayName('ReasonBridge Branches')
        description('Multi-branch pipeline for all ReasonBridge branches and PRs')
        branchSources {
          github {
            id('reasonbridge-github-source')
            repoOwner('steiner385')
            repository('ReasonBridge')
            scanCredentialsId('github-credentials')
            buildOriginBranch(true)
            buildOriginBranchWithPR(false)
            buildOriginPRMerge(true)
            buildOriginPRHead(false)
            buildForkPRMerge(false)
            // Disable automatic GitHub commit status notifications
            // We use explicit githubStatusReporter() calls in the pipeline instead
            traits {
              gitHubBranchDiscovery {
                strategyId(2)  // ONLY_PRS - only discover branches with open PRs
              }
              gitHubPullRequestDiscovery {
                strategyId(1)
              }
              gitHubForkDiscovery {
                strategyId(1)
                trust {
                  gitHubTrustContributors()
                }
              }
              gitHubSkipNotifications()
            }
          }
        }
        factory {
          workflowBranchProjectFactory {
            scriptPath('Jenkinsfile')
          }
        }
        orphanedItemStrategy {
          discardOldItems {
            numToKeep(30)
            daysToKeep(60)
          }
        }
        triggers {
          periodicFolderTrigger {
            interval('5 minutes')
          }
        }
      }

  # KinDash Nightly Build
  - script: |
      pipelineJob('KinDash-nightly') {
        description('Nightly comprehensive build - full test suite, security audits')
        definition {
          cpsScm {
            scm {
              git {
                remote {
                  url('https://github.com/steiner385/kindash-jenkins-lib.git')
                  credentials('github-credentials')
                }
                branch('*/main')
              }
            }
            scriptPath('Jenkinsfile.nightly')
          }
        }
        triggers {
          cron('0 1 * * *')
        }
        logRotator {
          numToKeep(14)
        }
      }

  # ReasonBridge Nightly Build
  - script: |
      pipelineJob('ReasonBridge-nightly') {
        description('Nightly comprehensive build - full test suite, security audits')
        definition {
          cpsScm {
            scm {
              git {
                remote {
                  url('https://github.com/steiner385/reasonbridge-jenkins-lib.git')
                  credentials('github-credentials')
                }
                branch('*/main')
              }
            }
            scriptPath('Jenkinsfile.nightly')
          }
        }
        triggers {
          cron('0 2 * * *')
        }
        logRotator {
          numToKeep(14)
        }
      }
