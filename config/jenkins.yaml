# Jenkins Configuration as Code (JCasC)
# uniteDiscord CI/CD Pipeline Configuration
#
# This file configures Jenkins for uniteDiscord CI/CD pipelines.
# Deploy by copying to Jenkins controller's $JENKINS_HOME/casc_configs/

jenkins:
  systemMessage: |
    uniteDiscord CI/CD Pipeline Server
    Library: https://github.com/steiner385/unitediscord-jenkins-lib
    URL: https://jenkins.kindash.com

  numExecutors: 0
  mode: EXCLUSIVE
  quietPeriod: 5
  scmCheckoutRetryCount: 3

  securityRealm:
    local:
      allowsSignup: false
      users: []

  authorizationStrategy:
    globalMatrix:
      entries:
        - user:
            name: "admin"
            permissions:
              - "Overall/Administer"
        - user:
            name: "tony"
            permissions:
              - "Overall/Administer"
        - group:
            name: "authenticated"
            permissions:
              - "Overall/Read"

  # Shared runner pool - 8 agents with capability-based labels
  nodes:
    - permanent:
        name: "runner-1"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 2
        mode: NORMAL
        labelString: "linux docker unit integration"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

    - permanent:
        name: "runner-2"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 2
        mode: NORMAL
        labelString: "linux docker unit integration"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

    - permanent:
        name: "runner-3"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 1
        mode: NORMAL
        labelString: "linux docker e2e playwright"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

    - permanent:
        name: "runner-4"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 1
        mode: NORMAL
        labelString: "linux docker e2e playwright"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

    - permanent:
        name: "runner-5"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 2
        mode: NORMAL
        labelString: "linux docker unit integration"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

    - permanent:
        name: "runner-6"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 2
        mode: NORMAL
        labelString: "linux docker unit integration"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

    - permanent:
        name: "runner-7"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 1
        mode: NORMAL
        labelString: "linux docker e2e playwright"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

    - permanent:
        name: "runner-8"
        remoteFS: "/home/jenkins/agent"
        numExecutors: 1
        mode: NORMAL
        labelString: "linux docker e2e playwright"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              internalDir: "remoting"
        retentionStrategy: "always"

  globalNodeProperties:
    - envVars:
        env:
          - key: "CI"
            value: "true"
          - key: "NODE_ENV"
            value: "test"
          - key: "JWT_SECRET"
            value: "test-jwt-secret"
          - key: "ENCRYPTION_KEY"
            value: "test-encryption-key-32-chars-long!"

security:
  globalJobDslSecurityConfiguration:
    useScriptSecurity: false

unclassified:
  # Global Pipeline Library - points to this repository
  globalLibraries:
    libraries:
      - name: "unitediscord-lib"
        defaultVersion: "main"
        implicit: false
        allowVersionOverride: true
        retriever:
          modernSCM:
            scm:
              git:
                remote: "https://github.com/steiner385/unitediscord-jenkins-lib.git"
                credentialsId: "github-credentials"

  location:
    adminAddress: "admin@kindash.com"
    url: "https://jenkins.kindash.com/"

  gitHubConfiguration:
    apiRateLimitChecker: ThrottleOnOver

  gitHubPluginConfig:
    configs:
      - credentialsId: "github-token"
        name: "GitHub"
        apiUrl: "https://api.github.com"
        manageHooks: true

  buildDiscarders:
    configuredBuildDiscarders:
      - "jobBuildDiscarder"

  timestamper:
    allPipelines: true

tool:
  git:
    installations:
      - name: "Default"
        home: "git"

credentials:
  system:
    domainCredentials:
      - credentials:
          - usernamePassword:
              scope: GLOBAL
              id: "github-credentials"
              username: "${GITHUB_USERNAME}"
              password: "${GITHUB_TOKEN}"
              description: "GitHub credentials"

          - string:
              scope: GLOBAL
              id: "github-token"
              secret: "${GITHUB_TOKEN}"
              description: "GitHub Personal Access Token"

          - string:
              scope: GLOBAL
              id: "database-url"
              secret: "postgresql://ci_user:ci_password@localhost:5433/ci_test_db"
              description: "Database URL for CI tests"

          - string:
              scope: GLOBAL
              id: "aws-access-key-id"
              secret: "${AWS_ACCESS_KEY_ID}"
              description: "AWS Access Key ID for Bedrock"

          - string:
              scope: GLOBAL
              id: "aws-secret-access-key"
              secret: "${AWS_SECRET_ACCESS_KEY}"
              description: "AWS Secret Access Key for Bedrock"

          - string:
              scope: GLOBAL
              id: "aws-region"
              secret: "${AWS_REGION:-us-east-1}"
              description: "AWS Region for Bedrock"

# Job Definitions
# All jobs load Jenkinsfiles from this lib repo, NOT from the application repo
jobs:
  # ==========================================================================
  # Multi-branch Pipeline - Primary CI/CD
  # ==========================================================================
  # Automatically builds all branches and PRs with:
  # - PR-specific builds with E2E tests
  # - Branch-specific deployment (main → prod, develop → staging)
  # - Orphan branch cleanup after 60 days
  - script: |
      multibranchPipelineJob('uniteDiscord-multibranch') {
        displayName('uniteDiscord Branches')
        description('Multi-branch pipeline for all uniteDiscord branches and PRs')

        branchSources {
          github {
            id('unitediscord-github-source')
            repoOwner('steiner385')
            repository('uniteDiscord')
            scanCredentialsId('github-credentials')

            // Build branches and PRs
            buildOriginBranch(true)
            buildOriginBranchWithPR(false)  // Avoid duplicate PR+branch builds
            buildOriginPRMerge(true)        // Build PR merge result
            buildOriginPRHead(false)        // Don't double-build PR head
            buildForkPRMerge(false)         // Security: don't build fork PRs
          }
        }

        // Load Jenkinsfile from library repo, not app repo
        factory {
          remoteJenkinsFileWorkflowBranchProjectFactory {
            scriptPath('Jenkinsfile.multibranch')
            remoteJenkinsFileSCM {
              gitSCM {
                userRemoteConfigs {
                  userRemoteConfig {
                    url('https://github.com/steiner385/unitediscord-jenkins-lib.git')
                    credentialsId('github-credentials')
                  }
                }
                branches {
                  branchSpec { name('*/main') }
                }
              }
            }
          }
        }

        // Cleanup old branches
        orphanedItemStrategy {
          discardOldItems {
            numToKeep(30)
            daysToKeep(60)
          }
        }

        // Scan for new branches every 5 minutes
        triggers {
          periodicFolderTrigger {
            interval('5 minutes')
          }
        }

        // Branch properties
        configure { node ->
          node / 'properties' / 'org.jenkinsci.plugins.workflow.multibranch.PipelineNotFoundBehavior' {
            'notFoundStrategy'('IGNORE')
          }
        }
      }

  # ==========================================================================
  # Nightly Build - Scheduled comprehensive tests
  # ==========================================================================
  - script: |
      pipelineJob('uniteDiscord-nightly') {
        description('Nightly comprehensive build - full test suite, security audits')
        definition {
          cpsScm {
            scm {
              git {
                remote {
                  url('https://github.com/steiner385/unitediscord-jenkins-lib.git')
                  credentials('github-credentials')
                }
                branch('*/main')
              }
            }
            scriptPath('Jenkinsfile.nightly')
          }
        }
        triggers {
          cron('0 2 * * *')
        }
        logRotator {
          numToKeep(14)
        }
      }
